// ----------------------------
// Prisma config
// ----------------------------
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------
// Producto
// ----------------------------
model Producto {
  id_prod                    Int                  @id @default(autoincrement())
  nombre_prod                String               @db.VarChar(120)
  tipo_prod                  String               @db.VarChar(20) // INSUMO, VENDIBLE, AMENITY, etc.
  stockeable_prod            Boolean
  vendible_prod              Boolean
  descuentaStockVenta_prod   Boolean
  stockMinimoGlobal_prod     Decimal?             @db.Decimal(18, 3)
  activo_prod                Boolean
  fechaAlta_prod             DateTime             @default(now())

  ProductoDepositos    ProductoDeposito[]
  DetallesComprobantes DetalleComprobante[]
}

// ----------------------------
// TipoDeposito
// ----------------------------
model TipoDeposito {
  id_tipoDep               Int      @id @default(autoincrement())
  nombre_tipoDep           String   @db.VarChar(80)
  esPuntoDeVenta_tipoDep   Boolean
  esConsumoInterno_tipoDep Boolean
  frecuenciaConteoDias_tipoDep Int
  activo_tipoDep           Boolean

  Depositos Deposito[]
}

// ----------------------------
// Deposito
// ----------------------------
model Deposito {
  id_dep          Int                @id @default(autoincrement())
  id_tipoDep      Int
  nombre_dep      String             @db.VarChar(80)
  ubicacion_dep   String?            @db.VarChar(120)
  activo_dep      Boolean
  fechaAlta_dep   DateTime           @default(now())

  TipoDeposito    TipoDeposito       @relation(fields: [id_tipoDep], references: [id_tipoDep])
  ProductoDepositos ProductoDeposito[]
  Comprobantes    Comprobante[]
  Movimientos     Movimiento[]
}

// ----------------------------
// ProductoDeposito
// ----------------------------
model ProductoDeposito {
  id_prodDep              Int      @id @default(autoincrement())

  id_prod                 Int
  id_dep                  Int

  minimo_prodDep          Decimal  @db.Decimal(18, 3)
  maximo_prodDep          Decimal? @db.Decimal(18, 3)
  loteReposicion_prodDep  Decimal? @db.Decimal(18, 3)
  ubicacion_prodDep       String?  @db.VarChar(30)

  Producto Producto @relation(fields: [id_prod], references: [id_prod])
  Deposito Deposito @relation(fields: [id_dep],  references: [id_dep])

  DetallesMovimientos DetalleMovimiento[]

  @@index([id_prod])
  @@index([id_dep])
}

// ----------------------------
// Proveedor
// ----------------------------
model Proveedor {
  id_prov         Int            @id @default(autoincrement())
  nombre_prov     String         @db.VarChar(120)
  cuit_prov       String         @db.VarChar(20)
  direccion_prov  String?        @db.VarChar(200)
  telefono_prov   String?        @db.VarChar(50)
  email_prov      String?        @db.VarChar(120)
  activo_prov     Boolean        @default(true)
  fechaAlta_prov  DateTime       @default(now())

  Comprobantes Comprobante[]
  Pagos        Pago[] // <-- RELACIÃ“N AÃ‘ADIDA
}

// ----------------------------
// FormaPago
// ----------------------------
model FormaPago {
  id_fp       Int           @id @default(autoincrement())
  nombre      String        @db.VarChar(80) // Efectivo, Transferencia, Cheque, etc.
  activo      Boolean       @default(true)

  Comprobantes Comprobante[]
  Pagos        Pago[] // <-- RELACIÃ“N AÃ‘ADIDA
}

// ----------------------------
// TipoMovimiento (Entrada / Salida)
// ----------------------------
model TipoMovimiento {
  id_tipoMov Int      @id @default(autoincrement())
  nombre     String   @db.VarChar(60) // Entrada, Salida
  direccion  String   @db.Char(3)     // IN | OUT
  activo     Boolean  @default(true)

  Movimientos Movimiento[]
}

// ----------------------------
// Movimiento (Encabezado)
// ----------------------------
model Movimiento {
  id_mov        Int             @id @default(autoincrement())
  id_tipoMov    Int
  id_tipoComp   Int?            // referencia opcional al tipo de comprobante
  fecha_mov     DateTime        @default(now())
  id_dep        Int             // depÃ³sito afectado
  observacion   String?         @db.VarChar(250)

  TipoMovimiento  TipoMovimiento    @relation(fields: [id_tipoMov], references: [id_tipoMov])
  TipoComprobante TipoComprobante?  @relation(fields: [id_tipoComp], references: [id_tipoComp])
  Deposito        Deposito          @relation(fields: [id_dep], references: [id_dep])

  Detalles DetalleMovimiento[]

  @@index([id_tipoMov])
  @@index([id_tipoComp])
  @@index([id_dep])
}

// ----------------------------
// DetalleMovimiento
// ----------------------------
model DetalleMovimiento {
  id_detMov    Int      @id @default(autoincrement())
  id_mov       Int
  id_prodDep   Int
  cantidad     Decimal  @db.Decimal(18, 3)

  Movimiento       Movimiento       @relation(fields: [id_mov], references: [id_mov])
  ProductoDeposito ProductoDeposito @relation(fields: [id_prodDep], references: [id_prodDep])

  @@index([id_mov])
  @@index([id_prodDep])
}

// ----------------------------
// TipoComprobante
// ----------------------------
model TipoComprobante {
  id_tipoComp Int       @id @default(autoincrement())
  codigo      String    @db.VarChar(10) // OC, FAC, REM, AJU, CON
  nombre      String    @db.VarChar(80)
  descripcion String?   @db.VarChar(200)
  afectaStock Boolean   @default(false)
  activo      Boolean   @default(true)

  Comprobantes Comprobante[]
  Movimientos  Movimiento[]
}

// ----------------------------
// Comprobante (Encabezado)
// ----------------------------
model Comprobante {
  id_comp               Int                @id @default(autoincrement())
  id_tipoComp           Int
  fecha                 DateTime
  estado                String             @db.VarChar(20) // BORRADOR, POSTED, PAGADO
  id_prov               Int?
  id_dep                Int?               // depÃ³sito relacionado si aplica
  id_fp                 Int?               // forma de pago si aplica
  observacion           String?            @db.VarChar(250)

  // Campos fiscales y de control
  letra_comp            String             @db.Char(1)     // A, B, C, M
  sucursal_comp         String             @db.Char(4)     // 0001
  numero_comp           String             @db.Char(8)     // 00000001
  total_comp            Decimal            @db.Decimal(18, 2)
  saldo_comp            Decimal            @db.Decimal(18, 2)

  // ðŸ”— RelaciÃ³n opcional a otro comprobante (ej: factura â†” orden de compra/remito)
  id_compRef            Int?
  ComprobanteRef        Comprobante?       @relation("ComprobanteReferencia", fields: [id_compRef], references: [id_comp])
  ComprobantesAsociados Comprobante[]      @relation("ComprobanteReferencia")

  TipoComprobante       TipoComprobante    @relation(fields: [id_tipoComp], references: [id_tipoComp])
  Proveedor             Proveedor?         @relation(fields: [id_prov], references: [id_prov])
  Deposito              Deposito?          @relation(fields: [id_dep], references: [id_dep])
  FormaPago             FormaPago?         @relation(fields: [id_fp], references: [id_fp])

  Detalles        DetalleComprobante[]
  DetallesPagos   DetallePago[] // <-- RELACIÃ“N AÃ‘ADIDA: Para saber a quÃ© pagos se imputÃ³ este comprobante

  @@index([id_tipoComp])
  @@index([id_prov])
  @@index([id_dep])
  @@index([id_fp])
  @@index([id_compRef])
}

// ----------------------------
// DetalleComprobante
// ----------------------------
model DetalleComprobante {
  id_det     Int      @id @default(autoincrement())
  id_comp    Int
  id_prod    Int
  cantidad   Decimal  @db.Decimal(18, 3)
  precio     Decimal? @db.Decimal(18, 2)

  Comprobante Comprobante @relation(fields: [id_comp], references: [id_comp])
  Producto    Producto    @relation(fields: [id_prod], references: [id_prod])

  @@index([id_comp])
  @@index([id_prod])
}

// ============================
// MODULOS DE PAGO (NUEVOS)
// ============================

// ----------------------------
// Pago (Encabezado de la TransacciÃ³n de Pago)
// ----------------------------
model Pago {
  id_pago         Int       @id @default(autoincrement())
  id_prov         Int       // Proveedor al que se le paga
  id_fp           Int       // Forma de Pago (Tipo de Pago)
  fecha_pago      DateTime  @default(now()) // Fecha de Pago
  total_pago      Decimal   @db.Decimal(18, 2) // Total Pagado
  observacion     String?   @db.VarChar(250)
  
  // Relaciones
  Proveedor       Proveedor   @relation(fields: [id_prov], references: [id_prov])
  FormaPago       FormaPago   @relation(fields: [id_fp], references: [id_fp])
  
  // Enlaces a los comprobantes que se pagan
  DetallesPagos   DetallePago[]

  @@index([id_prov])
  @@index([id_fp])
}

// ----------------------------
// DetallePago (Grilla de Comprobantes Pagados)
// ----------------------------
model DetallePago {
  id_detPago    Int       @id @default(autoincrement())
  id_pago       Int       // Referencia al encabezado del pago
  id_comp       Int       // Referencia al Comprobante que se estÃ¡ pagando
  monto_pagar   Decimal   @db.Decimal(18, 2) // Monto que se aplica a este comprobante
  
  // Relaciones
  Pago          Pago        @relation(fields: [id_pago], references: [id_pago])
  Comprobante   Comprobante @relation(fields: [id_comp], references: [id_comp])
  
  @@index([id_pago])
  @@index([id_comp])
}




// ============================
// HOTELERIA
// ============================




// ==========================================
// 1. TIPOS DE HABITACIÃ“N (ConfiguraciÃ³n)
// ==========================================
model TipoHabitacion {
  id_tipoHab      Int       @id @default(autoincrement())
  nombre          String    @db.VarChar(100)      // Simple, Doble, Suite
  descripcion     String?   @db.Text
  capacidad       Int                             // Personas mÃ¡ximas
  precioBase      Decimal   @db.Decimal(10,2)     // Precio por noche
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  Habitaciones    Habitacion[]
  DetallesReserva DetalleReserva[]
  Comodidades     TipoHabitacionComodidad[]  // ðŸ†• RelaciÃ³n con comodidades
  
  @@map("tipos_habitacion")
}

// ==========================================
// 2. COMODIDADES (Servicios/Amenities) ðŸ†•
// ==========================================
model Comodidad {
  id_comodidad    Int       @id @default(autoincrement())
  nombre          String    @db.VarChar(100)           // Wi-Fi, TV Cable, etc.
  icono           String?   @db.VarChar(50)            // ðŸ“¶, ðŸ“º, â„ï¸
  categoria       CategoriaComodidad @default(OTROS)   // Para agrupar
  descripcion     String?   @db.VarChar(250)
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  
  TiposHabitacion TipoHabitacionComodidad[]
  
  @@map("comodidades")
}

// Enum para categorÃ­as
enum CategoriaComodidad {
  BASICO           // Wi-Fi, Aire, CalefacciÃ³n
  ENTRETENIMIENTO  // TV, Netflix, Consola
  BANIO            // Jacuzzi, BaÃ±era, Secador
  SERVICIO         // Room Service, Desayuno, Minibar
  OTROS
}

// ==========================================
// 3. RELACIÃ“N N:M (Tipo HabitaciÃ³n - Comodidades) ðŸ†•
// ==========================================
model TipoHabitacionComodidad {
  id_tipoHab      Int
  id_comodidad    Int
  
  TipoHabitacion  TipoHabitacion @relation(fields: [id_tipoHab], references: [id_tipoHab], onDelete: Cascade)
  Comodidad       Comodidad @relation(fields: [id_comodidad], references: [id_comodidad], onDelete: Cascade)
  
  @@id([id_tipoHab, id_comodidad])
  @@map("tipo_habitacion_comodidades")
}

// ==========================================
// 4. HABITACIONES (Inventario fÃ­sico)
// ==========================================
model Habitacion {
  id_hab          Int       @id @default(autoincrement())
  numero          Int      @unique   // 101, 102, 201...
  id_tipoHab      Int
  piso            Int?
  estado          EstadoHabitacion @default(DISPONIBLE)
  activo          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  TipoHabitacion  TipoHabitacion @relation(fields: [id_tipoHab], references: [id_tipoHab])
  Estadias        Estadia[]
  
  @@index([id_tipoHab])
  @@index([estado])
  @@map("habitaciones")
}

enum EstadoHabitacion {
  DISPONIBLE
  OCUPADA
  LIMPIEZA
  MANTENIMIENTO
}

// ==========================================
// 5. HUÃ‰SPEDES (Clientes)
// ==========================================
model Huesped {
  id_huesped      Int       @id @default(autoincrement())
  nombre          String    @db.VarChar(100)
  apellido        String    @db.VarChar(100)
  documento       String?   @db.VarChar(50)
  telefono        String?   @db.VarChar(30)
  email           String?   @db.VarChar(120)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  Reservas        Reserva[]
  Estadias        Estadia[]
  
  @@index([documento])
  @@index([email])
  @@map("huespedes")
}

// ==========================================
// 6. RESERVAS (Compromiso futuro)
// ==========================================
model Reserva {
  id_reserva      Int       @id @default(autoincrement())
  codigoReserva   String    @unique @db.VarChar(20)   // RES-2025-0001
  id_huesped      Int
  fechaCheckIn    DateTime  @db.Date
  fechaCheckOut   DateTime  @db.Date
  cantAdultos     Int       @default(1)
  cantNinos       Int       @default(0)
  estado          EstadoReserva @default(PENDIENTE)
  total           Decimal   @db.Decimal(10,2)
  observaciones   String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  Huesped         Huesped @relation(fields: [id_huesped], references: [id_huesped])
  DetallesReserva DetalleReserva[]
  Estadias        Estadia[]
  
  @@index([id_huesped])
  @@index([fechaCheckIn])
  @@index([estado])
  @@map("reservas")
}

enum EstadoReserva {
  PENDIENTE
  CONFIRMADA
  CHECKED_IN
  CHECKED_OUT
  CANCELADA
}

// ==========================================
// 7. DETALLE RESERVA (Precio por noche)
// ==========================================
model DetalleReserva {
  id_detReserva   Int       @id @default(autoincrement())
  id_reserva      Int
  id_tipoHab      Int
  fechaNoche      DateTime  @db.Date
  precioNoche     Decimal   @db.Decimal(10,2)
  
  Reserva         Reserva @relation(fields: [id_reserva], references: [id_reserva], onDelete: Cascade)
  TipoHabitacion  TipoHabitacion @relation(fields: [id_tipoHab], references: [id_tipoHab])
  
  @@index([id_reserva])
  @@index([fechaNoche])
  @@map("detalles_reserva")
}

// ==========================================
// 8. ESTADÃAS (Check-in/Check-out real)
// ==========================================
model Estadia {
  id_estadia      Int       @id @default(autoincrement())
  id_hab          Int
  id_huesped      Int
  id_reserva      Int?                          // NULL si es walk-in
  fechaCheckIn    DateTime  @default(now())
  fechaCheckOut   DateTime?                     // NULL hasta checkout
  
  Habitacion      Habitacion @relation(fields: [id_hab], references: [id_hab])
  Huesped         Huesped @relation(fields: [id_huesped], references: [id_huesped])
  Reserva         Reserva? @relation(fields: [id_reserva], references: [id_reserva])
  
  @@index([id_hab])
  @@index([id_huesped])
  @@index([id_reserva])
  @@map("estadias")
}